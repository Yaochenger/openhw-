# 流水线细节

CV32E40P是一个4级流水线顺序发射/执行的处理器，这4级分别为：

- **取指（IF）**：通过一个对齐的预取缓冲区从内存中取指，只要指令存储系统允许，则可以每个时钟周期取1条指令。IF阶段也会将压缩指令进行预译码为RV32I基指令。参见[*取指*]()获取更多信息。
- **译码（ID）**：将从内存中取得的指令进行译码，并进行所需要的寄存器组的读取。无条件跳转（Jump）在ID阶段发生。
- **执行（EX）**：执行指令。EX阶段包含有ALU、乘法器和除法器。（符合跳转条件的）有条件跳转（Branch）在EX阶段发生。多周期指令会在此阶段停顿（Stall）直到其执行完毕。ALU、乘法器和除法器在EX阶段将其运算结果写回到寄存器组当中。加载存储单元（LSU）的地址生成部分也包含在EX阶段。
- **写回（WB）**：将加载（Load）系指令的结果写回到寄存器组当中。



## 多周期与单周期指令

下表展示了执行每种类型的指令所需要的时钟周期数。一些指令包含多种时钟周期，如范围 1 .. 32 表示该指令最小需要1个时钟周期而最多则需要32个时钟周期。该时钟周期数假设在指令内存接口以及数据内存接口上不需要停顿（即忽略访存的时钟周期）。

| 指令类型             | 时钟周期数                                                   | 描述                                                         |
| -------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 基本整型运算         | 1                                                            | 定义在RV32I中的基本整型计算指令。                            |
| CSR访问              | 4（mstatus, mepc, mtvec, mcause, mcy- cle, minstret, mhpmcounter*, mcycleh, minstreth, mhpmcounter*h, mcountin- hibit, mhpmevent*, dscr, dpc, dscratch0, dscratch1, privlv）<br>1（其他CSRs） | CSR访问指令在RISC-V标准的'Zicsr'部分。                       |
| 访存                 | 1<br>2（地址非字对齐的单字传输）<br>2（跨越字边界的半字传输）<br>4（cv.elw） | 通常的访存指令只需要在EX以及WB阶段分别执行1周期的1次总线传输事务。对于非对齐的单字传输以及跨越字边界的半字传输则需要在EX以及WB阶段分别执行2周期的2词总线传输事务。而**cv.elw**则需要4个周期。 |
| 乘法                 | 1（mul）<br>5（mulh、mulhsu、mulhu）                         | CV32E40P使用一个单周期32位x32位输出结果为32位的乘法器。而生成高位字结果需要5个周期进行运算。 |
| 除法、取模           | 3 .. 35<br>3 .. 35                                           | 除法所需要的周期数取决于除数的值（源操作数b），如除数前导0的位数。如果除数没有前导0则需要最小3个周期进行除法（如0x80000000）。最大的周期数为35个，此时除数为0。 |
| 无条件跳转           | 2<br>3（跳转目标是非字对齐非RVC指令）                        | 无条件跳转在ID阶段实现。执行无条件跳转时，IF阶段会被冲刷（包括预取缓冲区）。无条件跳转指令处于ID阶段的同时，新的PC请求会发送至指令内存接口。 |
| 有条件跳转（不执行） | 1                                                            | 不满足跳转条件的有条件跳转不会发生停顿。                     |
| 有条件跳转（执行）   | 3<br>4（跳转目标是非字对齐非RVC指令）                        | 计算跳转是否执行发生在EX阶段。如果满足跳转条件，则会刷新IF（包括预取缓冲区）以及ID阶段。 |
| 指令屏障             | 2<br>3（跳转目标是非字对齐非RVC指令）                        | FENCE.I指令定义在RISC-V标准的'Zifencei'部分。在内部其实现为无条件跳转到指令屏障紧接着的那条指令，因此会执行同无条件跳转一致的冲刷行为。 |



## 冒险

CV32E40P会在下列冒险发生时需要强制停顿1个时钟周期：

- 加载数据冒险（紧接着的指令会用到加载数据指令目标寄存器中的值）
- 无条件跳转目标寄存器（jalr）数据冒险（jalr指令依赖的寄存器rs1是上一条指令的目的寄存器）