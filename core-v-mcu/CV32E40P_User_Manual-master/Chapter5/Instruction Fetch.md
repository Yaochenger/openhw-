# 取指

在CV32E40P中，只要外部总线接口能够支持每个周期传输一个指令，那么CV32E40P则可以在IF阶段每个时钟周期输送一条指令到ID阶段。在执行压缩指令的情况下，在ID阶段平均每条指令需要少于32位的指令取指。

为了实现最佳性能以及定时关闭功能，处理器实现了一个预取器（prefetcher）用于从外部总线接口中取指，如外部连接的指令内存或者指令缓存。

预取单元实现了字对齐的32位指令预取，并将预取到的指令字存储到一个具有4个条目的FIFO中。而实现了此种（推测的）预取指的后果就是，CV32E40P可以在先正执行的代码区域外预取最多达4条指令字，并且要注意的是，在代码区域外执行的此种预取操作并不会产生不必要的读取副作用。

下表描述了用于指令预取的信号。这个接口是一个被LSU使用的简化版本，详细的版本请参见[*加载存储单元*]()一节。它们之间的主要区别在于预取单元所要使用的接口不需要写，因此可以使用更少的信号。

| 信号                  | 方向 | 描述                                                         |
| --------------------- | ---- | ------------------------------------------------------------ |
| `instr_req_o`         | 输出 | 请求有效信号，在`instr_gnt_i`置高电平一个周期前会保持高电平  |
| `instr_addr_o[31:0]`  | 输出 | 地址，字对齐                                                 |
| `instr_rdata_i[31:0]` | 输入 | 从存储器中读取的数据                                         |
| `instr_rvalid_i`      | 输入 | 当`instr_rvalid_i`为高时，`instr_rdata_i`保持着读取的有效数据。此时该信号会在每个请求刚好置高一个周期 |
| `instr_gnt_i`         | 输入 | 接口另一方接受了请求。`instr_addr_o`会在下个周期发生改变     |



## 非对齐的访问

在表面上来说，IF接口只能执行字对齐的取指。而非对齐的取指则以执行两个独立的字对齐取指来实现。在内部，内核会处理字对齐以及半字对齐的指令地址来支持压缩指令的取指。而地址的最低位在内部会被忽略。



## 协议

指令总线接口遵循OBI（Open Bus Interface，开放总线接口）协议，可以参照[这里](https://github.com/openhwgroup/core-v-docs/blob/master/cores/cv32e40p/OBI-v1.0.pdf)来查看协议的具体信息。CV32E40P的取指接口并没有实现下列可选的OBI信号：`we`、`be`、`wdata`、`auser`、`wuser`、`aid`、`rready`、`err`、`ruser`以及`rid`。CV32E40P取指接口可以触发2次连续的传输事务（two outstanding transactions）。图5.1以及5.2展示了协议的波形图。

![图5.1 连续内存传输](../images/obi_instruction_basic.svg)

![图5.2 多事务传输](../images/obi_instruction_multiple_outstanding.svg)